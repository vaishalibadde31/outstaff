{% extends "base.html" %}
{% block content %}
<div class="space-y-6">
  <div class="flex items-center justify-between">
    <div>
      <p class="text-sm uppercase tracking-wide text-brand-700 font-semibold">Certificates</p>
      <h1 class="text-3xl font-bold">{{ org.name }} certificates</h1>
      <p class="text-slate-600">Track compliance, expiry windows, and verification.</p>
    </div>
    <a class="btn btn-secondary" href="{{ url_for('orgs.view_org', org_id=org.id) }}">Back to org</a>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <div class="lg:col-span-2 card p-6 space-y-4">
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-semibold">Records</h2>
        <span class="pill">{{ certificates|length }} records</span>
      </div>
      <div class="space-y-3">
        {% for cert in certificates %}
        <div class="border border-slate-100 rounded-xl px-4 py-3">
          <div class="flex items-center justify-between">
            <div>
              <p class="font-semibold text-slate-900">{{ cert.certificate_type.name }}</p>
              <p class="text-sm text-slate-600">{{ cert.user.name }} • {{ cert.issue_date or 'No issue date' }} → {{ cert.expiry_date or 'No expiry' }}</p>
            </div>
            <span class="badge">{{ cert.status.value|capitalize }}</span>
          </div>
          <div class="mt-2 text-sm text-slate-600">
            {% if cert.attachment_url %}<a class="text-brand-700" href="{{ cert.attachment_url }}">Attachment</a>{% endif %}
            {% if cert.notes %}• {{ cert.notes }}{% endif %}
          </div>
          <div class="mt-3 flex gap-2 flex-wrap">
            {% if membership.role == Role.ADMIN %}
            <form method="POST" action="{{ url_for('certificates.update_status', org_id=org.id, certificate_id=cert.id) }}">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <select name="status" class="mr-2">
                {% for status in CertificateStatus %}
                <option value="{{ status.value }}" {% if status == cert.status %}selected{% endif %}>{{ status.name.title() }}</option>
                {% endfor %}
              </select>
              <button class="btn btn-secondary" type="submit">Update status</button>
            </form>
            {% endif %}
            <form method="POST" action="{{ url_for('certificates.delete_certificate', org_id=org.id, certificate_id=cert.id) }}" onsubmit="return confirm('Delete certificate?');">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button class="btn bg-rose-50 text-rose-700 hover:bg-rose-100" type="submit">Delete</button>
            </form>
          </div>
        </div>
        {% else %}
        <p class="text-slate-600">No certificates yet. Add one below.</p>
        {% endfor %}
      </div>
    </div>

    <div class="space-y-6">
      <div class="card p-6 space-y-3">
        <h3 class="text-lg font-semibold">Add certificate</h3>
        <form method="POST" class="space-y-3">
          {{ certificate_form.hidden_tag() }}
          <div class="space-y-2">
            {{ certificate_form.user_id.label }}
            {{ certificate_form.user_id(class_="w-full") }}
          </div>
          <div class="space-y-2">
            {{ certificate_form.type_id.label }}
            {{ certificate_form.type_id(class_="w-full") }}
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div class="space-y-2">
              {{ certificate_form.issue_date.label }}
              {{ certificate_form.issue_date(class_="w-full") }}
            </div>
            <div class="space-y-2">
              {{ certificate_form.expiry_date.label }}
              {{ certificate_form.expiry_date(class_="w-full") }}
            </div>
          </div>
          <div class="space-y-2">
            {{ certificate_form.attachment_url.label }}
            {{ certificate_form.attachment_url(class_="w-full") }}
          </div>
          <div class="space-y-2">
            {{ certificate_form.status.label }}
            {{ certificate_form.status(class_="w-full") }}
          </div>
          <div class="space-y-2">
            {{ certificate_form.notes.label }}
            {{ certificate_form.notes(class_="w-full") }}
          </div>
          <button class="btn btn-primary w-full" type="submit">{{ certificate_form.submit.label.text }}</button>
        </form>
      </div>

      {% if membership.role == Role.ADMIN %}
      <div class="card p-6 space-y-3">
        <h3 class="text-lg font-semibold">Certificate types</h3>
        <form method="POST" class="space-y-3">
          {{ type_form.hidden_tag() }}
          <div class="space-y-2">
            {{ type_form.name.label }}
            {{ type_form.name(class_="w-full") }}
          </div>
          <div class="space-y-2">
            {{ type_form.description.label }}
            {{ type_form.description(class_="w-full") }}
          </div>
          <button class="btn btn-secondary w-full" type="submit">{{ type_form.submit.label.text }}</button>
        </form>
        <div class="space-y-2 text-sm text-slate-600">
          {% for t in org.certificate_types %}
          <div class="flex items-center justify-between border border-slate-100 rounded-lg px-3 py-2">
            <span>{{ t.name }}</span>
            <span class="text-slate-500">Created {{ t.created_at.strftime('%Y-%m-%d') }}</span>
          </div>
          {% else %}
          <p>No types yet.</p>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
